name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: Test Ruby ${{ matrix.ruby }} / Rails ${{ matrix.rails }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        ruby: ['3.3', '3.4']
        rails: ['8.0', '8.1']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
      
      - name: Install dependencies with Rails version
        run: |
          gem install bundler
          # Create a Gemfile that overrides Rails version for testing
          cat > Gemfile.ci << EOF
          source "https://rubygems.org"
          
          gemspec
          
          # Override Rails version for CI testing
          gem 'rails', '~> ${{ matrix.rails }}.0'
          
          group :development, :test do
            gem "rake", "~> 13.0"
            gem "minitest", "~> 5.0"
            gem "sqlite3", "~> 2.0"
            gem "rubocop-rails-omakase", require: false
            gem "simplecov", "~> 0.22", require: false
            gem "simplecov-cobertura", "~> 2.1", require: false
          end
          EOF
          BUNDLE_GEMFILE=Gemfile.ci bundle install
      
      - name: Run tests with coverage
        run: BUNDLE_GEMFILE=Gemfile.ci bundle exec rake test
        env:
          RAILS_ENV: test
          COVERAGE: true
          CI: true
      
      - name: Build gem
        run: BUNDLE_GEMFILE=Gemfile.ci bundle exec rake build
      
      - name: Generate coverage XML
        if: matrix.ruby == '3.4' && matrix.rails == '8.1'
        run: |
          # Generate XML from SimpleCov results using a simple Ruby script
          BUNDLE_GEMFILE=Gemfile.ci bundle exec ruby -e "
            require 'simplecov'
            require 'simplecov-cobertura'
            
            # Configure SimpleCov
            SimpleCov.configure { command_name 'Unit Tests' }
            
            # Load results
            resultset = 'coverage/.resultset.json'
            unless File.exist?(resultset)
              puts 'Error: Coverage results not found'
              exit 1
            end
            
            # Merge and format
            result = SimpleCov::ResultMerger.merge_results(resultset)
            SimpleCov::Formatter::CoberturaFormatter.new.format(result)
            puts '✓ XML coverage generated'
          "
          
          # Verify XML exists
          if [ -f coverage/coverage.xml ]; then
            echo "✓ Coverage XML verified at coverage/coverage.xml"
            ls -lh coverage/coverage.xml
          else
            echo "✗ Error: Coverage XML not generated"
            ls -la coverage/ || echo "Coverage directory does not exist"
            exit 1
          fi
      
      - name: Upload coverage to Codacy
        if: matrix.ruby == '3.4' && matrix.rails == '8.1'
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage/coverage.xml
        continue-on-error: true

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true
      
      - name: Install dependencies
        run: |
          gem install bundler
          bundle install
      
      - name: Run RuboCop
        run: bundle exec rubocop
        continue-on-error: true
