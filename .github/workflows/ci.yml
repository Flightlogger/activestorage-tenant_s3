name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test:
    name: Test Ruby ${{ matrix.ruby }} / Rails ${{ matrix.rails }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        ruby: ['3.3', '3.4']
        rails: ['8.0', '8.1']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
      
      - name: Install dependencies with Rails version
        run: |
          gem install bundler
          # Create a Gemfile that overrides Rails version for testing
          cat > Gemfile.ci << EOF
          source "https://rubygems.org"
          
          gemspec
          
          # Override Rails version for CI testing
          gem 'rails', '~> ${{ matrix.rails }}.0'
          
          group :development, :test do
            gem "rake", "~> 13.0"
            gem "minitest", "~> 5.0"
            gem "sqlite3", "~> 2.0"
            gem "rubocop-rails-omakase", require: false
            gem "simplecov", "~> 0.22", require: false
            gem "simplecov-cobertura", "~> 3.1", require: false
          end
          EOF
          BUNDLE_GEMFILE=Gemfile.ci bundle install
      
      - name: Run tests with coverage
        run: BUNDLE_GEMFILE=Gemfile.ci bundle exec rake test
        env:
          RAILS_ENV: test
          COVERAGE: true
          CI: true
      
      - name: Build gem
        run: BUNDLE_GEMFILE=Gemfile.ci bundle exec rake build
      
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ruby-${{ matrix.ruby }}-rails-${{ matrix.rails }}
          path: coverage/coverage.xml
          if-no-files-found: ignore
          retention-days: 1

  upload-coverage:
    name: Upload coverage to Codacy
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          merge-multiple: false
          path: coverage-reports
      
      - name: Upload coverage to Codacy
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage-reports/**/coverage.xml
        continue-on-error: true

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true
      
      - name: Install dependencies
        run: |
          gem install bundler
          bundle install
      
      - name: Run RuboCop
        run: bundle exec rubocop
