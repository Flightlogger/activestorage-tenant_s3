Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (2.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.1ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:11:21.780883', '2026-01-20 12:11:21.780885') RETURNING "key"[0m
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (2.3ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.2ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:11:33.640994', '2026-01-20 12:11:33.640996') RETURNING "key"[0m
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (0.7ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.2ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.1ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:11:42.630618', '2026-01-20 12:11:42.630620') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:11:42', '2026-01-20 12:11:42.649817'), (298486374, 'Account Two', '2026-01-19 12:11:42', '2026-01-20 12:11:42.649817'), (113629430, 'Account Three', '2026-01-19 12:11:42', '2026-01-20 12:11:42.649817');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'kQM2B2E6DvMTbwHH4BPojH2d', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:11:42', 980190962, 'Account'), (NULL, 'XTD3o4fHZgDfsHD5kiFi12kY', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:11:42', 298486374, 'Account'), (NULL, '5v9dUsqBvjMnWVuZ86FQhtG9', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:11:42', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:11:42', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:11:42', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (2.6ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.3ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:12:10.224824', '2026-01-20 12:12:10.224826') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:12:10', '2026-01-20 12:12:10.249676'), (298486374, 'Account Two', '2026-01-19 12:12:10', '2026-01-20 12:12:10.249676'), (113629430, 'Account Three', '2026-01-19 12:12:10', '2026-01-20 12:12:10.249676');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'XNThp2p8TYbQWwV5ifuitogC', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:12:10', 980190962, 'Account'), (NULL, 'c5KQopB3D6rNt7cNjYVVeqnV', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:12:10', 298486374, 'Account'), (NULL, 'h93n7s4EvdCPK4TfK7DjyJ6e', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:12:10', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:12:10', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:12:10', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "3i87VyWNBUF4fR5rgmiasWtu"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:10.379542"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "shGz2Xb77Nz2V2Uurn9XMcGk"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:10.406787"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "5xBA6zJT1PKPZ75Ttsm5zd7h"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:10.407482"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 6], ["created_at", "2026-01-20 12:12:10.409645"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:12:10.409940"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 6], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 6]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 6]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:12:10.460107"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "vMXvQ3ezLK6CEwMLHYbAQQNE"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:10.460823"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "wyFsuLoiZu74TKVREpyZwn5x"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:10.461395"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "XNThp2p8TYbQWwV5ifuitogC"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.2ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.2ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.2ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "h93n7s4EvdCPK4TfK7DjyJ6e"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key h93n7s4EvdCPK4TfK7DjyJ6e. Using root path.
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "XNThp2p8TYbQWwV5ifuitogC"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (3.5ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.2ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:12:34.850414', '2026-01-20 12:12:34.850415') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:12:34', '2026-01-20 12:12:34.876274'), (298486374, 'Account Two', '2026-01-19 12:12:34', '2026-01-20 12:12:34.876274'), (113629430, 'Account Three', '2026-01-19 12:12:34', '2026-01-20 12:12:34.876274');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'VzEXZxh8goJZ6JJd5ZiFEC8w', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:12:34', 980190962, 'Account'), (NULL, 'aKj76mCWzhxrAb2vbEsenDL4', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:12:34', 298486374, 'Account'), (NULL, 'iT4qsi5eCbSCDwxCPFfpQi22', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:12:34', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:12:34', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:12:34', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "iT4qsi5eCbSCDwxCPFfpQi22"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key iT4qsi5eCbSCDwxCPFfpQi22. Using root path.
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "VzEXZxh8goJZ6JJd5ZiFEC8w"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.5ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "VzEXZxh8goJZ6JJd5ZiFEC8w"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.2ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.2ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.2ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.5ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.5ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "jX2zkeLEPmdTKj2BsD7hNx9h"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:38.091495"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 4], ["created_at", "2026-01-20 12:12:38.094153"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:12:38.094801"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 4], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 4]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 4]]
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:12:38.135193"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "yKAoPhoCi6Ki3zN4ErCJ1Lt9"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:38.146813"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "iu3nrVpEea94y3AXV51iWBCD"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:38.148201"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "tEfffGqNsBwdzfjVsHcMXTmP"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:38.149099"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "MzTHnZQwipoZQwqevXADQ58Q"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:38.149870"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (0.9ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:12:47.212067', '2026-01-20 12:12:47.212069') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:12:47', '2026-01-20 12:12:47.235432'), (298486374, 'Account Two', '2026-01-19 12:12:47', '2026-01-20 12:12:47.235432'), (113629430, 'Account Three', '2026-01-19 12:12:47', '2026-01-20 12:12:47.235432');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, '9PFZkp2qCqrCgf6Arc9T9XXD', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:12:47', 980190962, 'Account'), (NULL, 'A6aJtYXM9NhKP8pNwTQpPgt4', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:12:47', 298486374, 'Account'), (NULL, 'asnchbsEEPzLevrQSKYKywmx', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:12:47', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:12:47', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:12:47', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "asnchbsEEPzLevrQSKYKywmx"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key asnchbsEEPzLevrQSKYKywmx. Using root path.
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "9PFZkp2qCqrCgf6Arc9T9XXD"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.2ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.2ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "9PFZkp2qCqrCgf6Arc9T9XXD"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "mmgNm2N1wn76ZifJhesUo95U"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:50.412660"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "8TUUuYeXC72ZD3uT5e21S7KN"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:50.413858"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 5], ["created_at", "2026-01-20 12:12:50.414452"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:12:50.414791"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 5], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 5]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 5]]
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:12:50.441397"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "K9ctD8eN4PBqvB46iPcY6QL5"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:50.442583"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "MtfQE7V2FabS7hDbUyo1AQqj"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:50.463576"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "fJ8yPCjGXZCak5SUrutyycW4"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:12:50.464319"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (4.6ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.1ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:12:59.995754', '2026-01-20 12:12:59.995756') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:13:00', '2026-01-20 12:13:00.021523'), (298486374, 'Account Two', '2026-01-19 12:13:00', '2026-01-20 12:13:00.021523'), (113629430, 'Account Three', '2026-01-19 12:13:00', '2026-01-20 12:13:00.021523');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'RpT3Tyuf7KVBMTae7rqPRu9u', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:13:00', 980190962, 'Account'), (NULL, 'Zr4zMU3QrbhpbinWcCB1munL', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:13:00', 298486374, 'Account'), (NULL, 'zCKFnz2YcmqkJUGUCDkEMmUk', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:13:00', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:13:00', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:13:00', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "RpT3Tyuf7KVBMTae7rqPRu9u"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.2ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "RpT3Tyuf7KVBMTae7rqPRu9u"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.2ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "sz3tBu6N6Y7DdJvBBpJXZPzm"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:03.180459"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "UMz5KXVvN9Y8QpBREMRApcGL"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:03.181885"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "qKj6tv14fVqDPdD2oHREUfgc"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:03.182490"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "CCM9e1b1R6z9DTrr1rG1ozvJ"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:03.183240"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "djKWWnnJC7eg8No4mLUMtYac"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:03.183800"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 8], ["created_at", "2026-01-20 12:13:03.184423"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:13:03.184775"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 8], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 8]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 8]]
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:13:03.209234"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (0.8ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:13:07.509314', '2026-01-20 12:13:07.509316') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:13:07', '2026-01-20 12:13:07.528365'), (298486374, 'Account Two', '2026-01-19 12:13:07', '2026-01-20 12:13:07.528365'), (113629430, 'Account Three', '2026-01-19 12:13:07', '2026-01-20 12:13:07.528365');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'RbYqeRwgsQzapardaVVxqxTD', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:13:07', 980190962, 'Account'), (NULL, 'fm6uNK2S8CEidQYrKuxMX5Dt', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:13:07', 298486374, 'Account'), (NULL, 'jMZkFjTd4mpV3YxLznLGeh4B', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:13:07', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:13:07', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:13:07', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "P8XUJHQVrXjMbVAg4jQDVEEf"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:07.630817"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "mxqph6Tt1byAmfzsNA6TMgD2"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:07.632092"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "yBYzGtFKn5dvf2vdsPUSE4rv"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:07.632604"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "tNCyD75weYKVTX7vYncP7n3L"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:07.633183"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "v6PdY9FzjDGNRTNNMFcmvJkU"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:07.633654"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 8], ["created_at", "2026-01-20 12:13:07.637120"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:13:07.637395"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 8], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 8]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 8]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:13:07.659183"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 5], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "RbYqeRwgsQzapardaVVxqxTD"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "mxqph6Tt1byAmfzsNA6TMgD2"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key mxqph6Tt1byAmfzsNA6TMgD2. Using root path.
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "RbYqeRwgsQzapardaVVxqxTD"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.3ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (2.6ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.2ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:13:35.260648', '2026-01-20 12:13:35.260650') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:13:35', '2026-01-20 12:13:35.283110'), (298486374, 'Account Two', '2026-01-19 12:13:35', '2026-01-20 12:13:35.283110'), (113629430, 'Account Three', '2026-01-19 12:13:35', '2026-01-20 12:13:35.283110');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, '3uECLthqeNmALvhfvqEcnNKC', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:13:35', 980190962, 'Account'), (NULL, 'jsgqtB5BZ2ibg97fBbPVc6Xn', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:13:35', 298486374, 'Account'), (NULL, 'zPeD2CfRfB7k9Ub5RVkfUTV1', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:13:35', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:13:35', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:13:35', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "3uECLthqeNmALvhfvqEcnNKC"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "zPeD2CfRfB7k9Ub5RVkfUTV1"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key zPeD2CfRfB7k9Ub5RVkfUTV1. Using root path.
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "3uECLthqeNmALvhfvqEcnNKC"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "5WAAMHCdVwEqhq88LHNbAusq"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:35.427681"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "qdHqKWWctK8BXreq7fxaih4k"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:35.428545"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 5], ["created_at", "2026-01-20 12:13:35.429383"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:13:35.429646"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 5], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 5]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 5]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:13:35.452310"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "3pUS2RQS4WFAtAPSTnogwYFg"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:35.453024"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "CHgJUcGUVM9B8ABg7Ax3jPTV"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:35.453595"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "p3e5WMRadKUBXQtv9HADEggw"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:35.454959"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (1.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:13:39.794425', '2026-01-20 12:13:39.794427') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:13:39', '2026-01-20 12:13:39.813673'), (298486374, 'Account Two', '2026-01-19 12:13:39', '2026-01-20 12:13:39.813673'), (113629430, 'Account Three', '2026-01-19 12:13:39', '2026-01-20 12:13:39.813673');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, '11epRhba8BNCLhrpvfbHyZnx', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:13:39', 980190962, 'Account'), (NULL, 'PXeHZfRjo1jH4r89Re7SxNrs', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:13:39', 298486374, 'Account'), (NULL, 'LCWUscWoKL75hmBe7N6c7EzG', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:13:39', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:13:39', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:13:39', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.3ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "11epRhba8BNCLhrpvfbHyZnx"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "11epRhba8BNCLhrpvfbHyZnx"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "3Ln6a6RVNRakEAsTZN64WP55"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:39.934031"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "2159RcEpcQvUAuEJ4BcoFSAd"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:39.934792"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 5], ["created_at", "2026-01-20 12:13:39.935225"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:13:39.935460"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 5], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 5]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 5]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:13:39.954161"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "GKav1izdte9QAxXtwbY5vAKJ"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:39.955840"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "NrSXPzSdqHkuFM54UTz6a1RM"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:39.956369"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "Qu8LvQ25pSKVz6pyFqNEhpdo"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:39.956826"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (3.8ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:13:51.378288', '2026-01-20 12:13:51.378290') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:13:51', '2026-01-20 12:13:51.402838'), (298486374, 'Account Two', '2026-01-19 12:13:51', '2026-01-20 12:13:51.402838'), (113629430, 'Account Three', '2026-01-19 12:13:51', '2026-01-20 12:13:51.402838');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'RYEL1UH22M6tdhhoKzdBx7WP', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:13:51', 980190962, 'Account'), (NULL, 'u3UFug8zm2hZwFJBYZKuoyLW', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:13:51', 298486374, 'Account'), (NULL, 'KGck4PTpi7oSWY2GeXc6L5cU', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:13:51', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:13:51', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:13:51', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.3ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "2yjnRybejcuCCUDfB2u6drBG"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:51.533131"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 4], ["created_at", "2026-01-20 12:13:51.534187"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:13:51.534476"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 4], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 4]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 4]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:13:51.558736"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "1VRdac6K4CLgHVKABEKUnUZZ"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:51.559568"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "arC5MQ1A4byPg9M6yJc24woo"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:51.560127"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "f3qoSepG23H58NekjtQQNiZZ"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:51.560624"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "R1VWUX7EvVueD3dWip8fzrdb"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:13:51.561089"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "RYEL1UH22M6tdhhoKzdBx7WP"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "RYEL1UH22M6tdhhoKzdBx7WP"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "KGck4PTpi7oSWY2GeXc6L5cU"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key KGck4PTpi7oSWY2GeXc6L5cU. Using root path.
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (3.7ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.3ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:14:09.620655', '2026-01-20 12:14:09.620656') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:14:09', '2026-01-20 12:14:09.644818'), (298486374, 'Account Two', '2026-01-19 12:14:09', '2026-01-20 12:14:09.644818'), (113629430, 'Account Three', '2026-01-19 12:14:09', '2026-01-20 12:14:09.644818');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'JZLeHKLGjVuxLSoiyqcEk5TV', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:14:09', 980190962, 'Account'), (NULL, 'rquLEhYtZvzXmxg9eHd89rn6', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:14:09', 298486374, 'Account'), (NULL, 'aomSgA4RxBwEtPfUzu9Zgkb2', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:14:09', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:14:09', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:14:09', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.3ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "PMS96UCu2RGWPbgdCEsLdDjp"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:09.779089"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "tTLj3CLNB561iXLXN9cnRaZH"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:09.780471"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "ueoiftZ7gAiEen6xHnNAYyis"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:09.781222"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "38M2iFiM33yxPec9nZfRFMGk"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:09.781722"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 7], ["created_at", "2026-01-20 12:14:09.782303"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:09.782556"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 7], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 7]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 7]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:09.807877"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "r57V74Xyc13tqCteAbnGwGxM"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:09.808714"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "aomSgA4RxBwEtPfUzu9Zgkb2"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key aomSgA4RxBwEtPfUzu9Zgkb2. Using root path.
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "JZLeHKLGjVuxLSoiyqcEk5TV"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 8], ["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (0.8ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:14:13.980213', '2026-01-20 12:14:13.980215') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:14:13', '2026-01-20 12:14:13.998343'), (298486374, 'Account Two', '2026-01-19 12:14:13', '2026-01-20 12:14:13.998343'), (113629430, 'Account Three', '2026-01-19 12:14:13', '2026-01-20 12:14:13.998343');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'iF3SUR9PdPSsNKy5b4iMJEZY', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:14:13', 980190962, 'Account'), (NULL, 'nFXWDBYTiBrEvZWfzF8eGu14', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:14:13', 298486374, 'Account'), (NULL, 'SrSM4KZSTHuvJ23Ke7BuSHHS', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:14:13', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:14:13', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:14:13', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "iF3SUR9PdPSsNKy5b4iMJEZY"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "M45ra7HuApX9K2UEjokHrngk"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:14.117100"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "BuF3Qf6M7Ad4KU81gbLBopxm"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:14.117951"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "JA2EzsLeVJvoLwU6UC7iVTJc"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:14.118428"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "fAJA7dVXLzLwLziVfrpFGrtn"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:14.118865"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "Gv7vVyPumSVuP24rWFFCHHw2"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:14.120075"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 8], ["created_at", "2026-01-20 12:14:14.120463"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:14.120692"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 8], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 8]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 8]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:14.140461"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (0.7ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.1ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:14:18.324594', '2026-01-20 12:14:18.324601') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:14:18', '2026-01-20 12:14:18.342978'), (298486374, 'Account Two', '2026-01-19 12:14:18', '2026-01-20 12:14:18.342978'), (113629430, 'Account Three', '2026-01-19 12:14:18', '2026-01-20 12:14:18.342978');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'ZYNtSyJT2fWvrgASWrpQ78Ky', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:14:18', 980190962, 'Account'), (NULL, 'ZJx1XRXqAnq7WpyVsX5gZp3j', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:14:18', 298486374, 'Account'), (NULL, 'UVvjLjXPT88jep4aXVqpGoaJ', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:14:18', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:14:18', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:14:18', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.4ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "UVvjLjXPT88jep4aXVqpGoaJ"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key UVvjLjXPT88jep4aXVqpGoaJ. Using root path.
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "ZYNtSyJT2fWvrgASWrpQ78Ky"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "3qhNyTXkeCGDfnS1iyTgLo9A"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:18.462367"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 4], ["created_at", "2026-01-20 12:14:18.462985"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:18.463220"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 4], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 4]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 4]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:18.485305"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "XH3nsk3LFdNoJvfdXJEK5xBY"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:18.486028"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "m7iWea8b3ZLRiQsyBMKPvXS7"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:18.486572"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "TLR2vz24izjPZ2Sh8LgmdK13"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:18.487040"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "F9nsRemkMNuHPTCS85nc8Ln1"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:18.487639"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (3.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.2ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:14:29.331337', '2026-01-20 12:14:29.331339') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:14:29', '2026-01-20 12:14:29.354458'), (298486374, 'Account Two', '2026-01-19 12:14:29', '2026-01-20 12:14:29.354458'), (113629430, 'Account Three', '2026-01-19 12:14:29', '2026-01-20 12:14:29.354458');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, '5fdoTdnUBCS3pocRvUy1YiS2', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:14:29', 980190962, 'Account'), (NULL, '6WTJqAMKVBrzwYVWjAPiuwuV', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:14:29', 298486374, 'Account'), (NULL, 'aJcGSRFSYRJjc1AYVdWGTpWz', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:14:29', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:14:29', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:14:29', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.3ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "JC4zQrdc2L1iWaQ19FPBYcDB"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:29.483572"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "FsdzuoqTkTed4prhC7jijQX5"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:29.484896"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "KgLDuEgGWChDKXysaU9XWaxR"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:29.485985"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 6], ["created_at", "2026-01-20 12:14:29.486513"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:29.486770"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 6], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 6]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 6]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:29.512403"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "mudYNDfFgVPeg12kmP1yTq1K"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:29.513042"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "8rYDGBvRn3jFd1WrrqswocAF"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:29.513581"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "5fdoTdnUBCS3pocRvUy1YiS2"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "5fdoTdnUBCS3pocRvUy1YiS2"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "aJcGSRFSYRJjc1AYVdWGTpWz"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key aJcGSRFSYRJjc1AYVdWGTpWz. Using root path.
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (0.8ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:14:33.301005', '2026-01-20 12:14:33.301007') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:14:33', '2026-01-20 12:14:33.319233'), (298486374, 'Account Two', '2026-01-19 12:14:33', '2026-01-20 12:14:33.319233'), (113629430, 'Account Three', '2026-01-19 12:14:33', '2026-01-20 12:14:33.319233');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'XNxrGRw3wUBSjWwHFPs9GxF1', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:14:33', 980190962, 'Account'), (NULL, '7SvCKtZ1KJ35p57CkfLKXXV3', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:14:33', 298486374, 'Account'), (NULL, 'TXFkUgaQr98VBARcBbXZdjL5', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:14:33', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:14:33', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:14:33', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.4ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "Zae7dbKcx55RsHrXaU7kFbKE"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:33.427073"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "EHVi5iFEZjBEWW7LKaJ5G9eu"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:33.428821"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "US3FUwdpWrwQV8W2GCMTatC7"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:33.429341"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "1sGZ7tX2ucC6X3VXyQVFt2C1"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:33.429774"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 7], ["created_at", "2026-01-20 12:14:33.430245"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:33.430479"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 7], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 7]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 7]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:33.451093"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "9rpbwQcddd2vdnVhqxosPi9b"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:33.451771"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "XNxrGRw3wUBSjWwHFPs9GxF1"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "TXFkUgaQr98VBARcBbXZdjL5"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key TXFkUgaQr98VBARcBbXZdjL5. Using root path.
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "XNxrGRw3wUBSjWwHFPs9GxF1"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (0.7ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:14:37.345512', '2026-01-20 12:14:37.345513') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:14:37', '2026-01-20 12:14:37.363080'), (298486374, 'Account Two', '2026-01-19 12:14:37', '2026-01-20 12:14:37.363080'), (113629430, 'Account Three', '2026-01-19 12:14:37', '2026-01-20 12:14:37.363080');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'itxGjWmyKeQKeNvafjTbXTmw', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:14:37', 980190962, 'Account'), (NULL, 'gyCpmoce8jLn79CDT1mEHHpQ', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:14:37', 298486374, 'Account'), (NULL, 'itgkfB35g4Z84XhePcWHp4S3', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:14:37', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:14:37', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:14:37', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "itgkfB35g4Z84XhePcWHp4S3"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key itgkfB35g4Z84XhePcWHp4S3. Using root path.
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "itxGjWmyKeQKeNvafjTbXTmw"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "itxGjWmyKeQKeNvafjTbXTmw"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "Uz6ieEouDLL74dvvkc7dZb4S"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:37.480374"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "QVjvmDxHErvSzabmSzZdiR8t"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:37.481083"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "wpaGEYPwXAXSpbqmWM4Baki4"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:37.481537"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "xRwMSE8g34SdUFPjYwJh1uj7"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:37.481981"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "VcPgcRCxgbHxWDv5DZEmdYGi"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:37.483205"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 8], ["created_at", "2026-01-20 12:14:37.483627"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:37.483887"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 8], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 8]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 8]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:37.504595"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
Generating image variants require the image_processing gem. Please add `gem "image_processing", "~> 1.2"` to your Gemfile or set `config.active_storage.variant_processor = :disabled`.
  [1m[35m (0.8ms)[0m  [1m[35mDROP TABLE IF EXISTS "accounts"[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "accounts" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_blobs"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_blobs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "key" varchar NOT NULL, "filename" varchar NOT NULL, "content_type" varchar, "metadata" text, "service_name" varchar NOT NULL, "byte_size" bigint NOT NULL, "checksum" varchar, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_blobs_on_key" ON "active_storage_blobs" ("key")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_attachments"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_attachments" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "record_type" varchar NOT NULL, "record_id" bigint NOT NULL, "blob_id" bigint NOT NULL, "created_at" datetime(6) NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE INDEX "index_active_storage_attachments_on_blob_id" ON "active_storage_attachments" ("blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_attachments_uniqueness" ON "active_storage_attachments" ("record_type", "record_id", "name", "blob_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_storage_variant_records"[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "active_storage_variant_records" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "blob_id" bigint NOT NULL, "variation_digest" varchar NOT NULL, "tenant_id" bigint, "tenant_type" varchar)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_active_storage_variant_records_uniqueness" ON "active_storage_variant_records" ("blob_id", "variation_digest")[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.0ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.0ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-20 12:14:46.361070', '2026-01-20 12:14:46.361071') RETURNING "key"[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.1ms)[0m  [1m[35mPRAGMA foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = ON[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = OFF[0m
  [1m[36mFixtures Load (0.1ms)[0m  [1m[31mDELETE FROM "accounts";
DELETE FROM "active_storage_blobs";
DELETE FROM "active_storage_attachments";
INSERT INTO "accounts" ("id", "name", "created_at", "updated_at") VALUES (980190962, 'Account One', '2026-01-19 12:14:46', '2026-01-20 12:14:46.378480'), (298486374, 'Account Two', '2026-01-19 12:14:46', '2026-01-20 12:14:46.378480'), (113629430, 'Account Three', '2026-01-19 12:14:46', '2026-01-20 12:14:46.378480');
INSERT INTO "active_storage_blobs" ("id", "key", "filename", "content_type", "metadata", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'HtmuK4oEq9kUZCFbvyVSZ2Y2', 'test.pdf', 'application/pdf', NULL, 'tenant_s3', 1024, 'CY9rzUYh03PK3k6DJie09g==', '2026-01-19 12:14:46', 980190962, 'Account'), (NULL, 'DCQegosEsPiCMnQd7jdVq6WU', 'image.jpg', 'image/jpeg', NULL, 'tenant_s3', 2048, 'rQI0gpIFuQMxlrqBj3qHKw==', '2026-01-19 12:14:46', 298486374, 'Account'), (NULL, 'tLeTJ6wxMSYrTsYL7xMWorCk', 'old_file.pdf', 'application/pdf', NULL, 'tenant_s3', 512, 'FJYD5sA1FjYqjaI/Yk25RQ==', '2026-01-18 12:14:46', NULL, NULL);
INSERT INTO "active_storage_attachments" ("id", "name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (NULL, 'documents', 'Account', 980190962, 938051469, '2026-01-19 12:14:46', 980190962, 'Account'), (NULL, 'documents', 'Account', 298486374, 474975007, '2026-01-19 12:14:46', 298486374, 'Account')[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA defer_foreign_keys = 0[0m
  [1m[35m (0.0ms)[0m  [1m[35mPRAGMA foreign_keys = 1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Blob
--------------------------------------------------------------------
--------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::Attachment
--------------------------------------------------------------------------
-----------------------------------------------------------------------------
SetupTest: test_setup!_includes_CurrentTenant_in_ActiveStorage::VariantRecord
-----------------------------------------------------------------------------
----------------------------------------------------------------
SetupTest: test_ActiveStorage::Attachment_has_tenant_association
----------------------------------------------------------------
  [1m[36mActiveStorage::Attachment Load (0.4ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."tenant_id" IS NOT NULL ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.3ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------
SetupTest: test_ActiveStorage::Blob_has_tenant_association
----------------------------------------------------------
  [1m[36mActiveStorage::Blob Load (0.3ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
----------------------------------------------------------------------
CurrentTenantTest: test_does_not_set_tenant_when_Current.tenant_is_nil
----------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.2ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "DPoDQhdQdKcNtKkAyAxdxABy"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:46.483594"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------
CurrentTenantTest: test_creates_polymorphic_tenant_association
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ? LIMIT ?[0m  [["id", 980190962], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_creation_when_Current.tenant_is_set
--------------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "Y7sm3xhXvAzMxvHYr9kYx31q"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:46.485445"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------
CurrentTenantTest: test_sets_tenant_on_attachment_creation
----------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "SRjdDC4zgv25VEgArfAiThet"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:46.485937"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "documents"], ["record_type", "Account"], ["record_id", 113629430], ["blob_id", 6], ["created_at", "2026-01-20 12:14:46.486446"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:46.486696"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?[0m  [["record_id", 6], ["record_type", "ActiveStorage::Blob"], ["name", "preview_image"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Update (0.1ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "metadata" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["metadata", "{\"analyzed\":true}"], ["id", 6]]
  [1m[36mActiveStorage::Attachment Load (0.1ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ?[0m  [["blob_id", 6]]
  [1m[36mAccount Load (0.1ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" WHERE "accounts"."id" = ?[0m  [["id", 113629430]]
  [1m[36mAccount Update (0.0ms)[0m  [1m[33mUPDATE "accounts" SET "updated_at" = ? WHERE "accounts"."id" = ?[0m  [["updated_at", "2026-01-20 12:14:46.511579"], ["id", 113629430]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
--------------------------------------------------------------------------------
CurrentTenantTest: test_sets_tenant_id_and_tenant_type_on_blob_save_when_missing
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "GfJwujA5Ka97vsFeiH3B7V3X"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:46.512435"], ["tenant_id", 113629430], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
----------------------------------------------------------------------------
CurrentTenantTest: test_does_not_override_existing_tenant_id_and_tenant_type
----------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ? OFFSET ?[0m  [["LIMIT", 1], ["OFFSET", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[36mActiveStorage::Blob Create (0.1ms)[0m  [1m[32mINSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "service_name", "byte_size", "checksum", "created_at", "tenant_id", "tenant_type") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["key", "8xd1DgWJ4nkArrmjR9AaGJbh"], ["filename", "test.pdf"], ["content_type", "application/pdf"], ["service_name", "tenant_s3"], ["byte_size", 1024], ["checksum", "CY9rzUYh03PK3k6DJie09g=="], ["created_at", "2026-01-20 12:14:46.513342"], ["tenant_id", 298486374], ["tenant_type", "Account"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
---------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_record_type_when_no_attachment_exists
---------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 3], ["LIMIT", 1]]
---------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_record_type_when_available
---------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------
TenantS3ServiceTest: test_returns_nil_tenant_info_when_no_tenant_available
--------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_root_path_when_no_tenant_info_available
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.1ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "tLeTJ6wxMSYrTsYL7xMWorCk"], ["LIMIT", 1]]
ActiveStorage::TenantS3::Service::TenantS3Service: No tenant information available for key tLeTJ6wxMSYrTsYL7xMWorCk. Using root path.
------------------------------------------------------------------------
TenantS3ServiceTest: test_find_object_with_fallback_builds_correct_paths
------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "HtmuK4oEq9kUZCFbvyVSZ2Y2"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
--------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_path_with_fallback_to_ActiveStorage_when_record_type_is_nil
--------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
------------------------------------------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_Current.tenant_when_blob_has_no_tenant
------------------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Update (0.0ms)[0m  [1m[33mUPDATE "active_storage_blobs" SET "tenant_id" = ?, "tenant_type" = ? WHERE "active_storage_blobs"."id" = ?[0m  [["tenant_id", 113629430], ["tenant_type", "Account"], ["id", 3]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 3], ["LIMIT", 1]]
--------------------------------------------------------
TenantS3ServiceTest: test_extracts_tenant_info_from_blob
--------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_record_type_when_attachment_exists
--------------------------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
---------------------------------------------------------
TenantS3ServiceTest: test_sanitizes_record_type_correctly
---------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_extracts_record_type_from_attachment
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?[0m  [["id", 938051469], ["LIMIT", 1]]
--------------------------------------------------------------
TenantS3ServiceTest: test_builds_S3_path_with_tenant_structure
--------------------------------------------------------------
  [1m[36mAccount Load (0.0ms)[0m  [1m[34mSELECT "accounts".* FROM "accounts" ORDER BY "accounts"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."tenant_id" IS NOT NULL ORDER BY "active_storage_blobs"."id" ASC LIMIT ?[0m  [["LIMIT", 1]]
  [1m[36mActiveStorage::Blob Load (0.0ms)[0m  [1m[34mSELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."key" = ? LIMIT ?[0m  [["key", "HtmuK4oEq9kUZCFbvyVSZ2Y2"], ["LIMIT", 1]]
  [1m[36mActiveStorage::Attachment Load (0.0ms)[0m  [1m[34mSELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = ? ORDER BY "active_storage_attachments"."id" ASC LIMIT ?[0m  [["blob_id", 1], ["LIMIT", 1]]
-----------------------------------------------------------------------
RailtieTest: test_railtie_automatically_sets_up_on_Rails_initialization
-----------------------------------------------------------------------
------------------------------------
RailtieTest: test_railtie_is_defined
------------------------------------
